---
phase: 03-proxy-integration
plan: 01
type: execute
---

<objective>
Create proxy configuration and CA certificate installation scripts for Android emulator.

Purpose: Enable traffic interception through Burp Suite CE for security testing.
Output: Scripts to configure emulator proxy settings and install Burp CA certificate.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-generalization/02-02-SUMMARY.md

# Key files to modify/create:
@start-emulator.sh
@setup.sh

**Tech stack available:** bash, adb
**Established patterns:**
- Shell scripts accept args OR env vars
- Scripts check prerequisites before proceeding
- Helpful usage messages when args missing

**Constraining decisions:**
- [02-02]: Shell scripts accept package as argument OR from TARGET_PACKAGE env var
- [02-02]: AVD uses generic name `Android_Test_Device`

**Proxy approach (standard Android pattern):**
- Set global proxy via `adb shell settings put global http_proxy host:port`
- Install CA cert to user cert store (Android 7+) or system store (requires root)
- Burp Suite CE default proxy: 127.0.0.1:8080 on host = 10.0.2.2:8080 from emulator
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create configure-proxy.sh script</name>
  <files>configure-proxy.sh</files>
  <action>
Create a new script `configure-proxy.sh` that:
1. Accepts optional proxy host:port argument (default: 10.0.2.2:8080 - Burp on host)
2. Checks if emulator is running via `adb devices`
3. Configures global HTTP proxy via:
   - `adb shell settings put global http_proxy $PROXY_HOST:$PROXY_PORT`
4. Provides clear output showing:
   - Current proxy setting before change
   - New proxy setting after change
5. Add option to disable proxy (`--disable` or `--off`):
   - `adb shell settings put global http_proxy :0`
6. Include helpful usage message showing examples

Structure:
```bash
#!/bin/bash
# Configure Android emulator proxy settings
# Usage: ./configure-proxy.sh [host:port]
#        ./configure-proxy.sh --disable

PROXY="${1:-10.0.2.2:8080}"  # Default to Burp on host

if [ "$1" = "--disable" ] || [ "$1" = "--off" ]; then
    # Disable proxy
    adb shell settings put global http_proxy :0
    echo "Proxy disabled"
    exit 0
fi

# ... rest of implementation
```

Note: 10.0.2.2 is the Android emulator's special alias for host's localhost.
  </action>
  <verify>
# Script exists and is executable
chmod +x configure-proxy.sh
./configure-proxy.sh --help 2>&1 | head -5
# Should show usage message

# If emulator is running, verify proxy command works:
# adb shell settings get global http_proxy
  </verify>
  <done>
- configure-proxy.sh created and executable
- Accepts host:port argument or uses default
- --disable flag removes proxy
- Clear usage message shown
  </done>
</task>

<task type="auto">
  <name>Task 2: Create install-burp-cert.sh script</name>
  <files>install-burp-cert.sh</files>
  <action>
Create a script to install Burp Suite's CA certificate on the emulator:

1. Accept optional path to Burp CA cert (default: ~/burp-ca.der)
2. Check if cert file exists
3. Check if emulator is running
4. Convert DER to PEM if needed (Android prefers PEM for user certs)
5. Push certificate to emulator and install to user cert store:
   - Push to /sdcard/Download/burp-ca.crt
   - Provide instructions for manual install via Settings app
   - OR use `am` command to open security settings directly

For Android 7+, the simplest reliable method is:
1. Push cert to accessible location
2. Open certificate installer via intent
3. User confirms installation

Structure:
```bash
#!/bin/bash
# Install Burp Suite CA certificate on Android emulator
# Usage: ./install-burp-cert.sh [path/to/burp-ca.der]
#
# Get Burp CA cert: Burp > Proxy > Options > Import/Export CA > Export as DER

CERT_PATH="${1:-$HOME/burp-ca.der}"

# Check cert exists
if [ ! -f "$CERT_PATH" ]; then
    echo "ERROR: Certificate not found: $CERT_PATH"
    echo ""
    echo "Export Burp CA certificate:"
    echo "  1. Open Burp Suite"
    echo "  2. Proxy > Options"
    echo "  3. Import/Export CA Certificate"
    echo "  4. Export > Certificate in DER format"
    echo "  5. Save as: $CERT_PATH"
    exit 1
fi

# Convert DER to PEM (Android prefers .crt extension)
openssl x509 -inform DER -in "$CERT_PATH" -out /tmp/burp-ca.crt

# Push to emulator
adb push /tmp/burp-ca.crt /sdcard/Download/

# Open security settings for user to install
adb shell am start -n com.android.settings/.security.SecuritySettings

echo ""
echo "Certificate pushed to emulator."
echo ""
echo "Complete installation:"
echo "  1. Settings will open on emulator"
echo "  2. Scroll to 'Encryption & credentials'"
echo "  3. Tap 'Install a certificate' > 'CA certificate'"
echo "  4. Select 'burp-ca.crt' from Downloads"
echo "  5. Confirm installation"
```

Note: Fully automated cert install requires root or API 23-. For API 24+ (Android 7+), user cert install requires user confirmation for security.
  </action>
  <verify>
# Script exists and is executable
chmod +x install-burp-cert.sh

# Without cert, should show helpful message
./install-burp-cert.sh /nonexistent 2>&1 | grep -q "Export Burp CA" && echo "Shows export instructions - good"
  </verify>
  <done>
- install-burp-cert.sh created and executable
- Accepts path to Burp CA cert
- Converts DER to PEM format
- Pushes cert and opens settings for installation
- Clear instructions for obtaining and installing cert
  </done>
</task>

<task type="auto">
  <name>Task 3: Create start-emulator-proxy.sh convenience script</name>
  <files>start-emulator-proxy.sh</files>
  <action>
Create a convenience script that starts the emulator with proxy pre-configured:

1. Starts emulator using existing start-emulator.sh
2. Waits for emulator to boot
3. Configures proxy using configure-proxy.sh
4. Checks if Burp cert is installed (optional - just warn if not)
5. Prints summary of proxy status

Structure:
```bash
#!/bin/bash
# Start Android emulator with Burp proxy configured
# Usage: ./start-emulator-proxy.sh [proxy-host:port]
#
# Prerequisites:
#   - Burp Suite running on host (default: localhost:8080)
#   - Burp CA certificate installed (run install-burp-cert.sh first)

PROXY="${1:-10.0.2.2:8080}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Start emulator
"$SCRIPT_DIR/start-emulator.sh"

# Wait briefly for settings to be available
sleep 2

# Configure proxy
"$SCRIPT_DIR/configure-proxy.sh" "$PROXY"

echo ""
echo "=== Emulator Ready with Proxy ==="
echo "Proxy: $PROXY"
echo ""
echo "Verify Burp is receiving traffic:"
echo "  1. Open browser in emulator"
echo "  2. Visit any HTTP site"
echo "  3. Check Burp's HTTP History tab"
echo ""
echo "For HTTPS interception, ensure Burp CA is installed:"
echo "  ./install-burp-cert.sh"
```
  </action>
  <verify>
# Script exists and is executable
chmod +x start-emulator-proxy.sh

# Check it references the other scripts
grep -q "configure-proxy.sh" start-emulator-proxy.sh && echo "References configure-proxy.sh - good"
grep -q "start-emulator.sh" start-emulator-proxy.sh && echo "References start-emulator.sh - good"
  </verify>
  <done>
- start-emulator-proxy.sh created and executable
- Starts emulator and configures proxy automatically
- Provides verification instructions
- References Burp CA installation
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `ls configure-proxy.sh install-burp-cert.sh start-emulator-proxy.sh` succeeds
- [ ] All scripts are executable (`chmod +x`)
- [ ] `./configure-proxy.sh --help` shows usage
- [ ] `./install-burp-cert.sh` without args shows export instructions
- [ ] Scripts follow established patterns (helpful messages, prereq checks)
</verification>

<success_criteria>

- Three new scripts created for proxy workflow
- Scripts are self-documenting with clear usage messages
- Proxy configuration is reversible (--disable flag)
- CA certificate installation has clear instructions
- Integration with existing start-emulator.sh maintained
</success_criteria>

<output>
After completion, create `.planning/phases/03-proxy-integration/03-01-SUMMARY.md`
</output>
