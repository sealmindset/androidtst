---
phase: 05-code-browsing-workflow
plan: 01
type: execute
---

<objective>
Create unified APK analysis workflow with automated security scanning.

Purpose: Streamline the code examination process by combining decompilation tools and providing automated security pattern searches.
Output: Scripts that provide a one-command analysis workflow and quick security scans.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-apk-analysis-tooling/04-01-SUMMARY.md
@.planning/phases/04-apk-analysis-tooling/04-02-SUMMARY.md

# Key files:
@decompile-apk.sh
@decode-apk.sh
@README.md

**Tech stack available:** bash, adb, Python 3, jadx, apktool
**Established patterns:**
- Shell scripts accept args OR env vars
- Scripts auto-select most recent APK if none specified
- Output organized in decompiled/<app>/<tool>/ directory
- Check for required tools and show install instructions

**Constraining decisions:**
- [04-01]: Output structure is decompiled/<app>/<tool>/
- [04-02]: Dual tooling - jadx for Java source, apktool for manifest/resources
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analyze-apk.sh unified analysis script</name>
  <files>analyze-apk.sh</files>
  <action>
Create a new script `analyze-apk.sh` that:
1. Accepts APK path as argument OR uses most recent APK from apks/ directory
2. Checks for both jadx and apktool, shows install instructions if missing
3. Runs both decompile-apk.sh AND decode-apk.sh on the APK
4. After decompilation, automatically runs key security scans:
   - Count permissions from AndroidManifest.xml
   - List exported components (attack surface)
   - Check for cleartext traffic settings
   - Search for hardcoded secrets patterns
   - List network-related classes found
5. Outputs a summary report to stdout with findings organized by category
6. Provides next steps for manual investigation

Structure:
```bash
#!/bin/bash
# Unified APK analysis - decompile and scan for security issues
#
# Usage: ./analyze-apk.sh [path/to/app.apk]
#        (defaults to most recent APK in apks/ directory)
#
# Prerequisites:
#   - jadx installed: brew install jadx
#   - apktool installed: brew install apktool

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Tool checks
check_tools() {
    local missing=()
    command -v jadx &> /dev/null || missing+=("jadx")
    command -v apktool &> /dev/null || missing+=("apktool")

    if [ ${#missing[@]} -ne 0 ]; then
        echo "ERROR: Missing required tools: ${missing[*]}"
        echo ""
        echo "Install with Homebrew:"
        for tool in "${missing[@]}"; do
            echo "  brew install $tool"
        done
        exit 1
    fi
}

# Get APK path (same pattern as other scripts)
# ... [standard APK selection logic]

# Run decompilation tools
echo "=== APK Analysis ==="
echo ""
echo "Target: $APK_PATH"
echo ""

echo "[1/4] Decompiling to Java source (jadx)..."
"$SCRIPT_DIR/decompile-apk.sh" "$APK_PATH" > /dev/null 2>&1

echo "[2/4] Decoding resources (apktool)..."
"$SCRIPT_DIR/decode-apk.sh" "$APK_PATH" > /dev/null 2>&1

echo "[3/4] Scanning for security issues..."
# Run security scans

echo "[4/4] Generating report..."
# Output organized summary

echo ""
echo "=== Analysis Complete ==="
# Show organized findings and next steps
```

Key sections in output:
- **Permissions**: List all uses-permission entries
- **Attack Surface**: Exported activities, services, receivers, providers
- **Network Config**: cleartext traffic settings, domain configs
- **Potential Secrets**: Matches for api_key, secret, password, token patterns
- **Network Classes**: Files containing HTTP/OkHttp/Retrofit code
- **Next Steps**: Commands for deeper investigation
  </action>
  <verify>
chmod +x analyze-apk.sh
./analyze-apk.sh 2>&1 | head -15
# Should show usage or tool checks
  </verify>
  <done>
- analyze-apk.sh created and executable
- Runs both jadx and apktool
- Produces organized security summary
- Shows next steps for investigation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create search-code.sh for targeted pattern searches</name>
  <files>search-code.sh</files>
  <action>
Create a script `search-code.sh` for common security-focused code searches:

```bash
#!/bin/bash
# Search decompiled code for security-relevant patterns
#
# Usage: ./search-code.sh <pattern> [app-name]
#        ./search-code.sh --preset <preset-name> [app-name]
#
# Presets:
#   secrets   - API keys, passwords, tokens
#   network   - HTTP clients, URLs, endpoints
#   crypto    - Encryption, hashing, certificates
#   storage   - SharedPreferences, databases, files
#   auth      - Login, OAuth, JWT, session handling
#
# Examples:
#   ./search-code.sh "api.example.com"
#   ./search-code.sh --preset secrets
#   ./search-code.sh --preset network com.example.app

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Preset patterns
declare -A PRESETS
PRESETS[secrets]='(api_key|apikey|secret|password|token|credential).*='
PRESETS[network]='(HttpURLConnection|OkHttp|Retrofit|Volley|URL\(|\.fetch\()'
PRESETS[crypto]='(Cipher|MessageDigest|SecretKey|KeyStore|X509|SSL|TLS)'
PRESETS[storage]='(SharedPreferences|SQLiteDatabase|getFilesDir|getCacheDir|Room)'
PRESETS[auth]='(login|authenticate|oauth|jwt|session|bearer)'

# Parse arguments
# If --preset, use preset pattern
# Otherwise use literal pattern
# Optional app-name selects specific decompiled/<app>

# Find decompiled source directory
# Default to most recent in decompiled/*/jadx/sources

# Run grep with context lines
# Format output nicely with file:line references
```

Features:
- Preset patterns for common security searches
- Custom pattern search
- Optional app name filter
- Searches jadx/sources directory
- Shows file:line references for easy navigation
- Counts matches found
  </action>
  <verify>
chmod +x search-code.sh
./search-code.sh --help 2>&1 | head -20
# Should show usage with presets
  </verify>
  <done>
- search-code.sh created and executable
- Supports preset patterns and custom searches
- Searches decompiled jadx source
- Outputs file:line references
  </done>
</task>

<task type="auto">
  <name>Task 3: Update README with code browsing workflow</name>
  <files>README.md</files>
  <action>
Update README.md APK Analysis section:

1. Add "Quick Analysis" subsection before current "Decompiling APKs":
```markdown
### Quick Analysis

Run a complete analysis with one command:
```bash
./analyze-apk.sh com.example.app_v1.2.3.apk
# or auto-select most recent:
./analyze-apk.sh
```

This will:
- Decompile to Java source (jadx)
- Decode resources and manifest (apktool)
- Scan for common security issues
- Generate a summary report
```

2. Add "Searching Code" subsection after "Examining Code":
```markdown
### Searching Code

Use preset patterns for common security searches:
```bash
# Find hardcoded secrets
./search-code.sh --preset secrets

# Find network-related code
./search-code.sh --preset network

# Find crypto operations
./search-code.sh --preset crypto

# Find storage operations
./search-code.sh --preset storage

# Custom pattern search
./search-code.sh "api.example.com"
```

Available presets: secrets, network, crypto, storage, auth
```

3. Update Scripts Overview table to include new scripts:
- analyze-apk.sh | Unified APK analysis with security scan
- search-code.sh | Search decompiled code for patterns
  </action>
  <verify>
grep -q "analyze-apk.sh" README.md && echo "Documents analyze-apk.sh - good"
grep -q "search-code.sh" README.md && echo "Documents search-code.sh - good"
grep -q "Quick Analysis" README.md && echo "Has Quick Analysis section - good"
  </verify>
  <done>
- README documents unified analysis workflow
- README documents code search presets
- Scripts table updated
- Phase 5 complete
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] analyze-apk.sh exists and is executable
- [ ] search-code.sh exists and is executable
- [ ] Both scripts check for required tools
- [ ] README documents the complete workflow
- [ ] Scripts table includes both new scripts
</verification>

<success_criteria>

- Unified analysis script combines jadx + apktool + security scan
- Pattern search script provides preset and custom searches
- Complete code browsing workflow documented
- Phase 5: Code Browsing Workflow complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-code-browsing-workflow/05-01-SUMMARY.md`

Mark Phase 5 as complete in ROADMAP.md and STATE.md.
</output>
