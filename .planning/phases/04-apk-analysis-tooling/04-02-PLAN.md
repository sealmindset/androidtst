---
phase: 04-apk-analysis-tooling
plan: 02
type: execute
---

<objective>
Create apktool integration script for extracting APK resources and manifest.

Purpose: Enable examination of AndroidManifest.xml, resources, and smali code for security analysis.
Output: Script that decodes APKs using apktool with organized output structure.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-apk-analysis-tooling/04-01-SUMMARY.md

# Key files:
@extract-apk.sh
@decompile-apk.sh
@README.md

**Tech stack available:** bash, adb, Python 3, jadx
**Established patterns:**
- Shell scripts accept args OR env vars
- decompile-apk.sh auto-selects most recent APK if none specified
- Output organized in decompiled/<app>/ directory
- Helpful usage messages and install instructions

**Constraining decisions:**
- [04-01]: Output structure is decompiled/<app>/<tool>/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create decode-apk.sh script for apktool integration</name>
  <files>decode-apk.sh</files>
  <action>
Create a new script `decode-apk.sh` that:
1. Accepts APK path as argument OR uses most recent APK from apks/ directory
2. Checks if apktool is installed (`command -v apktool`), shows install instructions if not
3. Runs apktool decode with appropriate options:
   - `apktool d <apk> -o decompiled/<app-name>/apktool/ -f`
   - Use `-f` to force overwrite if output exists
4. Shows summary highlighting security-relevant files:
   - AndroidManifest.xml (permissions, components, exported)
   - res/xml/ (network security config, other configs)
   - smali/ (for low-level analysis)

Structure:
```bash
#!/bin/bash
# Decode APK to extract resources and manifest using apktool
#
# Usage: ./decode-apk.sh [path/to/app.apk]
#        (defaults to most recent APK in apks/ directory)
#
# Prerequisites:
#   - apktool installed: brew install apktool

set -e

# Check for apktool
if ! command -v apktool &> /dev/null; then
    echo "ERROR: apktool is not installed."
    echo ""
    echo "Install with Homebrew:"
    echo "  brew install apktool"
    exit 1
fi

# Get APK path (same pattern as decompile-apk.sh)
if [ -n "$1" ]; then
    APK_PATH="$1"
else
    APK_PATH=$(ls -t apks/*.apk 2>/dev/null | head -1)
    if [ -z "$APK_PATH" ]; then
        echo "ERROR: No APK specified and none found in apks/"
        echo ""
        echo "Usage: ./decode-apk.sh [path/to/app.apk]"
        echo ""
        echo "Extract an APK first: ./extract-apk.sh <package-name>"
        exit 1
    fi
fi

# Validate APK exists
if [ ! -f "$APK_PATH" ]; then
    echo "ERROR: APK not found: $APK_PATH"
    exit 1
fi

# Create output directory
APK_NAME=$(basename "$APK_PATH" .apk)
OUTPUT_DIR="decompiled/${APK_NAME}/apktool"

echo "=== APK Decoder (apktool) ==="
echo ""
echo "Input:  $APK_PATH"
echo "Output: $OUTPUT_DIR"
echo ""

# Run apktool decode
echo "Decoding APK..."
apktool d "$APK_PATH" -o "$OUTPUT_DIR" -f

echo ""
echo "=== Decode Complete ==="
echo ""
echo "Key files for security analysis:"
echo ""

# Show manifest info
if [ -f "$OUTPUT_DIR/AndroidManifest.xml" ]; then
    echo "AndroidManifest.xml:"
    PERMS=$(grep -c "uses-permission" "$OUTPUT_DIR/AndroidManifest.xml" 2>/dev/null || echo "0")
    EXPORTED=$(grep -c 'exported="true"' "$OUTPUT_DIR/AndroidManifest.xml" 2>/dev/null || echo "0")
    echo "  Permissions requested: $PERMS"
    echo "  Exported components: $EXPORTED"
    echo "  View: cat $OUTPUT_DIR/AndroidManifest.xml"
fi

echo ""

# Check for network security config
if [ -f "$OUTPUT_DIR/res/xml/network_security_config.xml" ]; then
    echo "Network Security Config found:"
    echo "  $OUTPUT_DIR/res/xml/network_security_config.xml"
    echo ""
fi

echo "Directories:"
echo "  $OUTPUT_DIR/AndroidManifest.xml - App manifest"
echo "  $OUTPUT_DIR/res/                 - Resources (layouts, strings, xml)"
echo "  $OUTPUT_DIR/smali/               - Smali bytecode"
echo ""
echo "Quick analysis:"
echo "  # View permissions"
echo "  grep 'uses-permission' $OUTPUT_DIR/AndroidManifest.xml"
echo ""
echo "  # Find exported components (potential attack surface)"
echo "  grep -B2 'exported=\"true\"' $OUTPUT_DIR/AndroidManifest.xml"
```
  </action>
  <verify>
chmod +x decode-apk.sh
./decode-apk.sh 2>&1 | head -10
# Should show usage or error about missing APK
  </verify>
  <done>
- decode-apk.sh created and executable
- Checks for apktool installation
- Accepts APK path or finds most recent
- Outputs to decompiled/<app>/apktool/
- Shows security-relevant analysis hints
  </done>
</task>

<task type="auto">
  <name>Task 2: Update README with apktool documentation</name>
  <files>README.md</files>
  <action>
Update the APK Analysis section in README.md to include apktool workflow:

In the "Decompiling APKs" subsection, add decode-apk.sh usage:
```markdown
# 3. Decode resources and manifest (optional)
./decode-apk.sh apks/app_v1.2.3.apk
# or auto-select most recent:
./decode-apk.sh

# Output structure:
# decompiled/<app>/apktool/AndroidManifest.xml - App manifest
# decompiled/<app>/apktool/res/                - Resources
# decompiled/<app>/apktool/smali/              - Smali bytecode
```

Add a new "Security Analysis Tips" subsection:
```markdown
### Security Analysis Tips

**Check permissions:**
```bash
grep 'uses-permission' decompiled/<app>/apktool/AndroidManifest.xml
```

**Find exported components (attack surface):**
```bash
grep -B2 'exported="true"' decompiled/<app>/apktool/AndroidManifest.xml
```

**Check for cleartext traffic:**
```bash
grep -i 'cleartextTrafficPermitted' decompiled/<app>/apktool/res/xml/*.xml
```

**Search for hardcoded secrets:**
```bash
grep -rE '(api_key|apikey|secret|password|token).*=' decompiled/<app>/jadx/sources/
```
```

Also update Scripts Overview table to include decode-apk.sh.
  </action>
  <verify>
grep -q "decode-apk.sh" README.md && echo "Documents decode-apk.sh - good"
grep -q "Security Analysis Tips" README.md && echo "Has Security Analysis Tips - good"
  </verify>
  <done>
- README updated with apktool workflow
- Security analysis tips documented
- Both decompilation tools have clear documentation
- Scripts table includes decode-apk.sh
  </done>
</task>

<task type="auto">
  <name>Task 3: Update .env.example and metadata</name>
  <files>.env.example, .planning/ROADMAP.md</files>
  <action>
1. Add decompiled/ to .gitignore if not already present (don't want to commit decompiled code)

2. Update ROADMAP.md to mark Phase 4 plan 01 description more accurately:
   - 04-01: jadx integration for Java source decompilation
   - 04-02: apktool integration for resource extraction

No changes needed to .env.example (decompilation tools don't need env vars).
  </action>
  <verify>
# Check .gitignore includes decompiled/
grep -q "decompiled" .gitignore 2>/dev/null || echo "decompiled/" >> .gitignore && echo "Added decompiled/ to .gitignore"
  </verify>
  <done>
- decompiled/ directory excluded from git
- Phase 4 documentation accurate
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] decode-apk.sh exists and is executable
- [ ] Script checks for apktool installation
- [ ] README documents both jadx and apktool workflows
- [ ] Security analysis tips documented
- [ ] decompiled/ excluded from git
- [ ] Phase 4 complete
</verification>

<success_criteria>

- apktool integration script created and functional
- Complete APK analysis workflow documented
- Security analysis tips help users find vulnerabilities
- Phase 4: APK Analysis Tooling complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-apk-analysis-tooling/04-02-SUMMARY.md`

Mark Phase 4 as complete in ROADMAP.md and STATE.md.
</output>
