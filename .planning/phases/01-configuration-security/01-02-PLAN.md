---
phase: 01-configuration-security
plan: 02
type: execute
---

<objective>
Refactor test_idor.py to use config module and implement secure temp file handling with cleanup.

Purpose: Eliminate hardcoded credentials from source code and secure temporary file storage to prevent credential leakage.
Output: Secure test_idor.py that uses environment configuration and properly handles sensitive temp files.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/phases/01-configuration-security/01-01-SUMMARY.md

**Depends on:** Plan 01-01 must be complete (config module exists)

**Security issues to fix (from CONCERNS.md):**
1. CRITICAL: Hardcoded credentials at lines 17-19
2. MEDIUM: JWT token in world-readable /tmp/jwt_token.txt (line 86)
3. MEDIUM: Cookies in world-readable /tmp/test_cookies.txt (line 106)
4. MEDIUM: No cleanup of temp files

**Source file:** test_idor.py (353 lines)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hardcoded credentials with config module</name>
  <files>test_idor.py</files>
  <action>
1. Add import at top: `from config import config`
2. Remove hardcoded credential lines (17-19):
   ```python
   TEST_EMAIL = "ravance@gmail.com"
   TEST_PASSWORD = "Test3214@"
   YOUR_SLEEPER_ID = "-9223372019953519548"
   ```
3. Replace all usages throughout file:
   - `TEST_EMAIL` -> `config.test_email`
   - `TEST_PASSWORD` -> `config.test_password`
   - `YOUR_SLEEPER_ID` -> `config.sleeper_id`
   - `API_BASE` (line 21) -> `config.api_base`

Do NOT change any other logic or functionality.
  </action>
  <verify>grep -n "TEST_EMAIL\|TEST_PASSWORD\|YOUR_SLEEPER_ID" test_idor.py returns no hardcoded values, only config references</verify>
  <done>No hardcoded credentials in test_idor.py, all values come from config module</done>
</task>

<task type="auto">
  <name>Task 2: Implement secure temp file handling</name>
  <files>test_idor.py</files>
  <action>
1. Add imports: `import tempfile`, `import os`, `import atexit`

2. Create secure temp file helper at module level:
   ```python
   # Secure temp file paths (created on first use)
   _temp_files = []

   def get_secure_temp_file(suffix: str) -> str:
       """Create a secure temp file with restricted permissions."""
       fd, path = tempfile.mkstemp(suffix=suffix, prefix="android_test_")
       os.close(fd)
       os.chmod(path, 0o600)  # Owner read/write only
       _temp_files.append(path)
       return path

   def cleanup_temp_files():
       """Clean up all temp files created during testing."""
       for path in _temp_files:
           try:
               if os.path.exists(path):
                   os.remove(path)
           except OSError:
               pass

   atexit.register(cleanup_temp_files)
   ```

3. Replace hardcoded /tmp paths:
   - Line 86: `Path("/tmp/jwt_token.txt")` -> use secure temp file
   - Line 106: `-c /tmp/test_cookies.txt` -> use secure temp file

4. Store paths in module-level variables for reuse within the session.
  </action>
  <verify>grep -n "/tmp/" test_idor.py returns only informational prints, not actual file paths</verify>
  <done>All temp files use secure permissions (0o600) and are cleaned up on exit</done>
</task>

<task type="auto">
  <name>Task 3: Update user-facing messages to reflect secure handling</name>
  <files>test_idor.py</files>
  <action>
1. Update the print statements that reference /tmp/jwt_token.txt:
   - Line 87: "Saved to /tmp/jwt_token.txt" should indicate secure temp location
   - Line 94: "Check if token is in /tmp/jwt_token.txt" should reflect new behavior

2. Add a note about the temp file location being session-specific and auto-cleaned.

3. Keep the logic for checking existing JWT token - but look in the secure location.

Keep messages clear and actionable for users.
  </action>
  <verify>python3 -c "import test_idor" imports without error (with .env file present)</verify>
  <done>User messages updated to reflect secure temp file handling</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `grep -rn "ravance@gmail.com\|Test3214@" .` returns nothing (no credentials in code)
- [ ] `grep -n "0o600" test_idor.py` shows chmod for temp files
- [ ] `grep -n "atexit" test_idor.py` shows cleanup registration
- [ ] `python3 -c "import test_idor"` works (with valid .env)
- [ ] No changes to test logic or API interaction behavior
</verification>

<success_criteria>
- All tasks completed
- No credentials in source code
- Temp files use 0o600 permissions
- Cleanup registered via atexit
- Test script behavior unchanged (only credential source and temp handling differ)
- Phase 1 complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-configuration-security/01-02-SUMMARY.md`

Mark Phase 1 as complete in ROADMAP.md and STATE.md.
</output>
